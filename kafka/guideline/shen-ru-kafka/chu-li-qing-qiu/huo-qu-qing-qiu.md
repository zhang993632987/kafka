# 获取请求

请求需要发送给指定的分区首领，所以客户端需要通过查询**元数据**来确保请求被路由到正确的节点上。首领在收到请求时会先检查请求是否有效，比如，指定的偏移量在分区中是否存在？如果客户端请求的数据已被删除，或者请求的偏移量不存在，则broker会返回错误。如果请求的偏移量存在，那么broker将按照客户端指定的数量上限从分区中读取消息，再把消息返回给客户端。

{% hint style="info" %}
## <mark style="color:blue;">提示</mark>

<mark style="color:blue;">**Kafka使用零复制技术向客户端发送消息。**</mark>

**Kafka会直接把消息从文件（或者更确切地说是Linux文件系统缓存）里发送到网络通道，不需要经过任何中间缓冲区。这项技术避免了字节复制，也不需要管理内存缓冲区，从而能够获得更好的性能**。这是Kafka与其他大部分数据库系统不一样的地方，其他数据库在将数据发送给客户端之前会先把它们保存在本地缓存中。
{% endhint %}

{% hint style="info" %}
## <mark style="color:blue;">提示</mark>

**并不是所有保存在分区首领上的数据都可以被客户端读取。**

* [<mark style="color:blue;">**大部分客户端只能读取已经被写入所有同步副本的消息**</mark>](#user-content-fn-1)[^1]。
* 分区首领知道哪些消息已经被复制到哪些副本上，所以**消息在还没有被写入所有同步副本之前是不会被发送给消费者的**——尝试获取这些消息的请求会得到空响应，而不是错误。

之所以这样，是因为还没有被足够多分区副本复制的消息被认为是“不安全”的：

* 如果首领发生崩溃，另一个副本成为新首领，那么这些消息就丢失了。
* 如果允许客户端读取只存在于首领中的消息，则可能会出现不一致的行为。

所以，我们**会等到所有同步副本都复制了消息，才允许消费者读取它们**。

这也意味着，<mark style="color:blue;">**如果broker间的消息复制因为某些原因变慢，那么消息到达消费者的时间也会变长（因为会先等待消息复制完毕）**</mark>。最大延迟时间可以通过参数**replica.lag.time.max.ms**来配置，它**指定了分区副本在复制消息时最多出现多长的延迟仍然被认为是同步的**。
{% endhint %}

{% hint style="info" %}
## <mark style="color:blue;">提示</mark>

除了可以设置broker返回数据的**上限**，客户端也可以设置broker返回数据的**下限**。

* 如果把下限设置为10 KB，就好像是在告诉broker“等到有10 KB数据时再把它们返回给我”。**在主题消息流量不是很大的情况下，这样可以减少CPU和网络开销**。
* 当然，我们不会一直让客户端等待broker累积数据。客户端可以在等待了一段时间之后就开始处理可用的数据，而不是一直等待下去。所以，客户端可以定义一个**超时时间**，告诉broker“如果你无法在x毫秒内累积足够多的数据，就把当前这些数据返回给我”。

客户端还可以指定**一个分区最多可以返回多少数据**。这个限制非常重要，因为客户端需要为broker返回的数据分配足够的内存。如果没有这个限制，并且broker返回了大量的数据，则可能会耗尽客户端的内存。
{% endhint %}

{% hint style="info" %}
## <mark style="color:blue;">提示</mark>

在某些情况下，**消费者需要读取大量的分区。在每个发送给broker的请求中都包含整个分区清单并让broker返回所有的元数据的做法是非常低效的，**因为**分区及其元数据其实很少会发生变化**。

为了最小化这种开销，**Kafka提供了**<mark style="color:blue;">**请求会话缓存**</mark>**。**

* **消费者可以尝试创建一个会话，会话中保存了它们正在读取的分区及其元数据信息。**
* **在创建了会话之后，消费者将不需要在每个请求中都指定分区，而是使用增量式请求。broker只会在分区及其元数据发生变化时才将它们包含在响应中**。

不过，会话缓存的空间是有限的，**Kafka会优先保存需要处理大量分区的跟随者副本和消费者的会话**，所以，**在某些情况下，broker可能不会创建会话，甚至会将会话清理掉**。对于这两种情况，broker将向客户端返回错误，客户端可以重新发起包含所有分区元数据的请求。
{% endhint %}

[^1]: 跟随者副本除外（尽管它们也是消费者），否则复制功能将无法正常工作&#x20;
