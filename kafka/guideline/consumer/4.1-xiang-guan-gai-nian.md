# 4.1 相关概念

## 1 消费者和消费者群组

<mark style="color:blue;">**Kafka消费者从属于消费者群组。一个群组里的消费者订阅的是同一个主题，每个消费者负责读取这个主题的部分消息。**</mark>

<mark style="color:blue;">**向群组里添加消费者是横向扩展数据处理能力的主要方式**</mark>。Kafka消费者经常需要执行一些高延迟的操作，比如把数据写到数据库或用数据做一些比较耗时的计算。在这些情况下，单个消费者无法跟上数据生成的速度，因此可以增加更多的消费者来分担负载，让每个消费者只处理部分分区的消息，这是横向扩展消费者的主要方式。于是，我们可以为主题创建大量的分区，当负载急剧增长时，可以加入更多的消费者。不过需要注意的是，<mark style="color:red;">**不要让消费者的数量超过主题分区的数量，因为多余的消费者只会被闲置**</mark>。

**不同于传统的消息系统，横向伸缩消费者和消费者群组并不会导致Kafka性能下降。**

## 2 消费者群组和分区再均衡

**消费者群组里的消费者共享主题分区的所有权**。当一个新消费者加入群组时，它将开始读取一部分原本由其他消费者读取的消息。当一个消费者被关闭或发生崩溃时，它将离开群组，原本由它读取的分区将由群组里的其他消费者读取。主题发生变化（比如管理员添加了新分区）会导致分区重分配。

<mark style="color:blue;">**分区的所有权从一个消费者转移到另一个消费者的行为称为再均衡**</mark><mark style="color:blue;">。</mark>再均衡非常重要，它为消费者群组带来了高可用性和伸缩性（你可以放心地添加或移除消费者）。不过，在正常情况下，我们并不希望发生再均衡。

{% hint style="info" %}


根据消费者群组所使用的分区分配策略的不同，再均衡可以分为两种类型：

* <mark style="color:blue;">**主动再均衡**</mark>：**在进行主动再均衡期间，所有消费者都会停止读取消息，放弃分区所有权，重新加入消费者群组，并获得重新分配到的分区。这样会导致整个消费者群组在一个很短的时间窗口内不可用。**这个时间窗口的长短取决于消费者群组的大小和几个配置参数。主动再均衡包含两个不同的阶段：第一个阶段，所有消费者都放弃分区所有权；第二个阶段，消费者重新加入群组，获得重新分配到的分区，并继续读取消息。
* <mark style="color:blue;">**协作再均衡**</mark>：**协作再均衡（也称为增量再均衡）通常是指将一个消费者的部分分区重新分配给另一个消费者，其他消费者则继续读取没有被重新分配的分区**。这种再均衡包含两个或多个阶段。在第一个阶段，消费者群组首领会通知所有消费者，它们将失去部分分区的所有权，然后消费者会停止读取这些分区，并放弃对它们的所有权。在第二个阶段，消费者群组首领会将这些没有所有权的分区分配给其他消费者。**虽然这种增量再均衡可能需要进行几次迭代，直到达到稳定状态，但它避免了主动再均衡中出现的“停止世界”停顿**。这对大型消费者群组来说尤为重要，因为它们的再均衡可能需要很长时间。
{% endhint %}

消费者会向被指定为<mark style="color:blue;">**群组协调器**</mark>的broker（不同消费者群组的协调器可能不同）发送心跳，以此来保持群组成员关系和对分区的所有权关系。**心跳是由消费者的一个后台线程发送的，只要消费者能够以正常的时间间隔发送心跳，它就会被认为还“活着”**。如果消费者在足够长的一段时间内没有发送心跳，那么它的会话就将超时，群组协调器会认为它已经“死亡”，进而触发再均衡。

## 3 群组固定成员

**在默认情况下，消费者的群组成员身份标识是临时的。当一个消费者离开群组时，分配给它的分区所有权将被撤销；当该消费者重新加入时，将通过再均衡协议为其分配一个新的成员ID和新分区。**

可以给消费者分配一个唯一的<mark style="color:blue;">**group.instance.id**</mark>，让它成为<mark style="color:blue;">**群组的固定成员**</mark>。通常，当消费者第一次以固定成员身份加入群组时，群组协调器会按照分区分配策略给它分配一部分分区。**当这个消费者被关闭时，它不会自动离开群组——它仍然是群组的成员，直到会话超时（session.timeout.ms）**。**当这个消费者重新加入群组时，它会继续持有之前的身份，并分配到之前所持有的分区**。群组协调器缓存了每个成员的分区分配信息，只需要将缓存中的信息发送给重新加入的固定成员，**不需要进行再均衡**。
