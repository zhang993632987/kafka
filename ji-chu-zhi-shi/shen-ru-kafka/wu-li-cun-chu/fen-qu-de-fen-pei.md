# 分区的分配

在创建主题时，Kafka 首先要决定如何在 broker 间分配分区。

**假设你有 6 个broker，打算创建一个包含 10 个分区的主题，并且复制系数为 3，那么总共会有 30 个分区副本，它们将被分配给 6 个broker**，此时，分配方案如下：

* <mark style="color:blue;">**先随机选择一个 broker（假设是4），然后使用轮询的方式给每个 broker 分配分区首领**</mark>。于是：
  * 分区 0 的首领在 broker 4 上
  * 分区 1 的首领在 broker 5 上
  * 分区 2 的首领在 broker 0 上（因为只有 6 个 broker）
  * 以此类推
* <mark style="color:blue;">**接下来，从分区首领开始，依次分配跟随者副本**</mark>。
  * 如果分区 0 的首领在 broker 4 上，那么它的第一个跟随者副本就在 broker 5 上，第二个跟随者副本就在 broker 0 上。
  * 如果分区 1 的首领在 broker 5 上，那么它的第一个跟随者副本就在 broker 0 上，第二个跟随者副本在 broker 1 上。

{% hint style="info" %}
## <mark style="color:blue;">提示</mark>

<mark style="color:blue;">**如果配置了机架信息，那么就不是按照数字顺序而是按照机架交替的方式来选择 broker 了**</mark>。

假设 broker 0 和 broker 1 被放置在一个机架上，broker 2 和 broker 3 被放置在另一个机架上。我们不是按照从 0 到 3 的顺序来选择 broker，而是按照 0、2、1、3 的顺序来选择，以保证**相邻的 broker 总是位于不同的机架上**。

于是，如果分区 0 的首领在 broker 2 上，那么第一个跟随者副本就在 broker 1 上，以保证它们位于不同的机架上。因为如果第一个机架离线，则还有其他幸存的副本，所以分区仍然可用。这对所有副本来说都是一样的，因此在机架离线时仍然能够保证可用性。
{% endhint %}

为分区和副本选好合适的 broker 之后，接下来要决定新分区应该被放在哪个目录。我们会为每个分区分配目录，规则很简单：**计算每个目录里的分区数量，新分区总是会被放在分区数量最少的那个目录**。也就是说，如果添加了一个新磁盘，那么所有新分区都会被放到这个磁盘。这是因为在达到均衡分配的状态之前，新磁盘的分区数量总是最少的。
