# 复制系数

主题级别的配置参数是 <mark style="color:blue;">**replication.factor**</mark>。在 broker 级别，可以通过 <mark style="color:blue;">**default.replication.factor**</mark> 来设置自动创建的主题的复制系数。

**副本的位置分布也很重要。**<mark style="color:blue;">**Kafka 可以确保分区的每个副本被放在不同的 broker 上**</mark>。但是，在某些情况下，这样仍然不够安全。如果一个分区的所有副本所在的 broker 位于同一个机架上，那么一旦机架的交换机发生故障，不管设置了多大的复制系数，这个分区都不可用。<mark style="color:blue;">**为了避免机架级别的故障，建议把 broker分布在多个不同的机架上，并通过 broker.rack 参数配置每个 broker 所在的机架的名字**</mark>**。**如果配置了机架名字，那么 Kafka 就会保证分区的副本被分布在多个机架上，从而获得更高的可用性。<mark style="color:blue;">**如果是在云端运行Kafka，则可以将可用区域视为机架。**</mark>

> ## 一个主题需要几个副本？
>
> 需要综合考虑以下因素：
>
> * <mark style="color:blue;">**可用性**</mark>：**副本越多，可用性就越高**。
> * <mark style="color:blue;">**持久性**</mark>：每个副本都包含了一个分区的所有数据。**如果有更多的副本，并且这些副本位于不同的存储设备中，那么丢失所有副本的概率就降低了。**
> * <mark style="color:blue;">**吞吐量**</mark>：**每增加一个副本都会增加 broke r内的复制流量**。如果以 10 MBps的速率向一个分区发送数据，并且只有 1 个副本，那么不会增加任何的复制流量。如果有 2 个副本，则会增加 10 MBps 的复制流量，3 个副本会增加 20 MBps的复制流量，5 个副本会增加 40 MBps 的复制流量。在规划集群大小和容量时，需要把这个考虑在内。
> * <mark style="color:blue;">**端到端延迟**</mark>：每一条记录必须被复制到所有同步副本之后才能被消费者读取。从理论上讲，**副本越多，出现滞后的可能性就越大，因此会降低消费者的读取速度**。在实际当中，如果一个 broker 由于各种原因变慢，那么它就会影响所有的客户端，而不管复制系数是多少。
> * <mark style="color:blue;">**成本**</mark>**：**一般来说，出于成本方面的考虑，非关键数据的复制系数应该小于 3。**数据副本越多，存储和网络成本就越高。**因为很多存储系统已经将每个数据块复制了 3 次，所以有时候可以将 Kafka 的复制系数设置为 2，以此来降低成本。需要注意的是，与复制系数 3 相比，这样做仍然会降低可用性，但可以由存储设备来提供持久性保证。
