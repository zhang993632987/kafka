# 复制

<mark style="color:blue;">**Kafka的复制机制和分区多副本架构是Kafka可靠性保证的核心**</mark><mark style="color:blue;">。</mark>把消息写入多个副本可以保证Kafka在发生崩溃时仍然能够提供消息的持久性。

**Kafka的主题会被分为多个分区，分区是最基本的数据构建块。**分区存储在单个磁盘上，**Kafka可以保证分区中的事件是有序的**。一个分区可以在线（可用），也可以离线（不可用）。每个分区可以有多个**副本**，其中有一个副本是**首领**。所有的事件都会被发送给首领副本，通常情况下消费者也直接从首领副本读取事件。其他副本只需要与首领保持同步，及时从首领那里复制最新的事件。当首领副本不可用时，其中一个同步副本将成为新首领。

**分区的首领肯定是同步副本**，而对**跟随者副本**来说，则需要满足以下条件才能被认为是同步副本。

* **与ZooKeeper之间有一个活跃的会话**，也就是说，它在过去的6秒（可配置）内向ZooKeeper发送过心跳。
* **在过去的10秒（可配置）内从首领那里复制过消息**。
* **在过去的10秒内从首领那里复制过最新的消息**。仅从首领那里复制消息是不够的，它还必须在每10秒（可配置）内复制一次最新的消息。

如果跟随者副本不能满足以上任何一点（比如与ZooKeeper断开连接，或者不再复制新消息，或者复制消息滞后了10秒以上），那么它就会被认为是不同步的。一个不同步的副本可以通过与ZooKeeper重新建立连接并从首领那里复制最新的消息重新变成同步副本。

<mark style="color:blue;">**一个稍有滞后的同步副本会导致生产者和消费者变慢，因为在消息被认为已提交之前，客户端会等待所有同步副本确认消息**</mark>。如果一个副本变成不同步的，那么我们就不再关心它是否已经收到消息。这个时候，<mark style="color:blue;">**虽然不同步副本同样是滞后的，但它不影响性能。然而，更少的同步副本意味着更小的有效复制系数，因此在停机时丢失数据的风险就更大了。**</mark>
