# 消费者群组和分区再均衡

> ## <mark style="color:blue;">**消费者群组里的消费者共享主题分区的所有权**</mark>
>
> * 当一个新消费者加入群组时，它将开始读取一部分原本由其他消费者读取的消息。
> * 当一个消费者被关闭或发生崩溃时，它将离开群组，原本由它读取的分区将由群组里的其他消费者读取。
> * 主题发生变化（比如管理员添加了新分区）会导致分区重分配。

<mark style="color:blue;">**分区的所有权从一个消费者转移到另一个消费者的行为称为再均衡**</mark><mark style="color:blue;">。</mark>再均衡非常重要，它为消费者群组带来了**高可用性**和**伸缩性**（你可以放心地添加或移除消费者）。

消费者会向被指定为<mark style="color:blue;">**群组协调器**</mark>的 broker（不同消费者群组的协调器可能不同）发送心跳，以此来保持群组成员关系和对分区的所有权关系。**心跳是由消费者的一个后台线程发送的，只要消费者能够以正常的时间间隔发送心跳，它就会被认为还“活着”**。如果消费者在足够长的一段时间内没有发送心跳，那么它的会话就将超时，群组协调器会认为它已经“死亡”，进而触发再均衡。

**根据消费者群组所使用的分区分配策略的不同，再均衡可以分为两种类型**：

* <mark style="color:blue;">**主动再均衡**</mark>：**在进行主动再均衡期间，所有消费者都会停止读取消息，放弃分区所有权，重新加入消费者群组，并获得重新分配到的分区。**
  * **这样会导致整个消费者群组在一个很短的时间窗口内不可用。**这个时间窗口的长短取决于消费者群组的大小和几个配置参数。
  * 主动再均衡包含两个不同的阶段：
    1. 第一个阶段，所有消费者都放弃分区所有权；
    2. 第二个阶段，消费者重新加入群组，获得重新分配到的分区，并继续读取消息。
* <mark style="color:blue;">**协作再均衡**</mark>：**协作再均衡（也称为增量再均衡）通常是指将一个消费者的部分分区重新分配给另一个消费者，其他消费者则继续读取没有被重新分配的分区**。
  * 这种再均衡包含两个或多个阶段：
    1. 在第一个阶段，消费者群组首领会通知所有消费者，它们将失去部分分区的所有权，然后消费者会停止读取这些分区，并放弃对它们的所有权。
    2. 在第二个阶段，消费者群组首领会将这些没有所有权的分区分配给其他消费者。
  * **虽然这种增量再均衡可能需要进行几次迭代，直到达到稳定状态，但它避免了主动再均衡中出现的“停止世界”停顿**。这对大型消费者群组来说尤为重要，因为它们的再均衡可能需要很长时间。
